<div class="reservation-detail-container">
    <!-- Loading State -->
    <div
        *ngIf="loading()"
        class="loading-container"
    >
        <tui-loader class="loader"></tui-loader>
        <p>
            {{ 'reservations.loading' | translate }}
        </p>
    </div>

    <!-- Error State -->
    <div
        *ngIf="error() && !loading()"
        class="error-container"
    >
        <tui-icon
            icon="@tui.alert-circle"
            class="error-icon"
        ></tui-icon>
        <p>{{ error() }}</p>
        <button
            tuiButton
            type="button"
            appearance="secondary"
            (click)="onBackClick()"
        >
            {{ 'reservations.backToList' | translate }}
        </button>
    </div>

    <div
        *ngIf="isDataLoaded()"
        class="reservation-content detail-view"
    >
        <!-- Header -->
        <div class="reservation-header">
            <button
                tuiButton
                type="button"
                appearance="secondary"
                size="s"
                (click)="onBackClick()"
                class="back-button"
            >
                <tui-icon icon="@tui.arrow-left"></tui-icon>
                {{ 'reservations.back' | translate }}
            </button>

            <div class="header-info">
                <h1>
                    {{ 'reservations.detail.title' | translate }}
                </h1>
                <tui-chip
                    [size]="'m'"
                    [appearance]="getStatusAppearance(reservation()!.status)"
                >
                    {{ getStatusLabel(reservation()!.status) }}
                </tui-chip>

                <!-- Retry Payment Button -->
                <button
                    *ngIf="canRetryPayment()"
                    tuiButton
                    type="button"
                    appearance="primary"
                    size="m"
                    (click)="onRetryPayment()"
                    class="retry-payment-button"
                >
                    <tui-icon icon="@tui.refresh"></tui-icon>
                    {{ 'reservations.payment.retryPayment' | translate }}
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="reservation-main">
            <!-- Left Column: Space Info -->
            <div class="space-section">
                <div class="space-card">
                    <img
                        [src]="getMainImage()"
                        [alt]="space()!.name"
                        class="space-image"
                    >

                    <div class="space-info">
                        <h2>{{ space()!.name }}</h2>
                        <p class="space-type">
                            <tui-icon icon="@tui.home"></tui-icon>
                            {{ getSpaceTypeLabel(space()!.type) }}
                        </p>
                        <p
                            class="space-description"
                            *ngIf="space()!.description"
                        >
                            {{ space()!.description }}
                        </p>

                        <button
                            tuiButton
                            type="button"
                            appearance="outline"
                            size="m"
                            (click)="onViewSpace()"
                            class="view-space-button"
                        >
                            <tui-icon icon="@tui.eye"></tui-icon>
                            {{ 'reservations.detail.viewSpace' | translate }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Reservation Details -->
            <div class="details-section">
                <!-- Dates -->
                <div class="detail-card">
                    <h3>
                        <tui-icon icon="@tui.calendar"></tui-icon>
                        {{ 'reservations.detail.dates' | translate }}
                    </h3>
                    <div class="detail-content">
                        <div class="date-item">
                            <span class="label">
                                {{ 'reservations.detail.startDate' | translate }}
                            </span>
                            <span class="value">
                                {{ formatDate(reservation()!.startDate) }}
                                <span class="time">
                                    {{ formatTime(reservation()!.startDate) }}
                                </span>
                            </span>
                        </div>
                        <div class="date-separator">
                            <tui-icon icon="@tui.arrow-down"></tui-icon>
                        </div>
                        <div class="date-item">
                            <span class="label">
                                {{ 'reservations.detail.endDate' | translate }}
                            </span>
                            <span class="value">
                                {{ formatDate(reservation()!.endDate) }}
                                <span class="time">
                                    {{ formatTime(reservation()!.endDate) }}
                                </span>
                            </span>
                        </div>
                        <div class="duration-item">
                            <tui-icon icon="@tui.clock"></tui-icon>
                            <span>
                                {{ getDuration() }} {{ 'reservations.detail.days' | translate }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Access Code -->
                <div
                    class="detail-card"
                    *ngIf="reservation()!.accessCode"
                >
                    <h3>
                        <tui-icon icon="@tui.key"></tui-icon>
                        {{ 'reservations.detail.accessCode' | translate }}
                    </h3>
                    <div class="detail-content">
                        <div class="access-code-display">
                            <span class="code">{{ reservation()!.accessCode!.code }}</span>
                            <p class="code-hint">
                                {{ 'reservations.detail.accessCodeHint' | translate }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Payment/Confirmation Block for PENDING_PAYMENT and PAYMENT_FAILED -->
                <div
                    class="detail-card"
                    *ngIf="shouldShowPaymentView()"
                >
                    <h3>
                        <tui-icon icon="@tui.credit-card"></tui-icon>
                        {{ 'reservations.payment.pricing' | translate }}
                    </h3>
                    <div class="detail-content">
                        <div class="price-breakdown">
                            <div class="price-item">
                                <span>
                                    {{ 'reservations.payment.basePrice' | translate }}
                                </span>
                                <span>{{ space()!.pricing.tenantPrice }}€</span>
                            </div>
                            <div class="price-item">
                                <span>
                                    {{ 'reservations.payment.numberOfDays' | translate }}
                                </span>
                                <span>{{ calculateDays() }}</span>
                            </div>
                            <div class="price-item subtotal">
                                <span>
                                    {{ 'reservations.payment.subtotal' | translate }}
                                </span>
                                <span>{{ calculateSubtotal() }}€</span>
                            </div>
                            <div
                                class="price-item"
                                *ngIf="reservation()?.cleaningFee && reservation()!.cleaningFee > 0"
                            >
                                <span>
                                    {{ 'reservations.payment.cleaningFee' | translate }}
                                </span>
                                <span>{{ reservation()!.cleaningFee }}€</span>
                            </div>
                            <div
                                class="price-item"
                                *ngIf="calculatePlatformFeeTotal() > 0"
                            >
                                <span>
                                    {{ 'reservations.payment.platformFee' | translate }}
                                </span>
                                <span>{{ formatPlatformFeeTotal() }}€</span>
                            </div>
                            <div
                                class="price-item"
                                *ngIf="reservation()?.deposit && reservation()!.deposit > 0"
                            >
                                <span>
                                    {{ 'reservations.payment.deposit' | translate }}
                                </span>
                                <span>{{ reservation()!.deposit }}€</span>
                            </div>
                            <div class="price-item total">
                                <span>
                                    <strong>
                                        {{ 'reservations.payment.total' | translate }}
                                    </strong>
                                </span>
                                <span>
                                    <strong>{{ calculateTotalPrice() }}€</strong>
                                </span>
                            </div>
                        </div>

                        <!-- Free reservation message -->
                        <div
                            *ngIf="isFreeReservation()"
                            class="free-reservation-notice"
                        >
                            <tui-icon icon="@tui.gift"></tui-icon>
                            <p>
                                {{ 'reservations.payment.freeReservationNotice' | translate }}
                            </p>
                        </div>

                        <!-- Payment Timer -->
                        <div
                            class="payment-timer"
                            *ngIf="timeRemaining() && !isExpired() && reservation()!.status === 'PENDING_PAYMENT'"
                        >
                            <div
                                class="timer-display"
                                [class.warning]="getTimeRemainingMinutes() < 5"
                            >
                                <tui-icon icon="@tui.clock-fading"></tui-icon>
                                <span>
                                    {{ 'reservations.payment.timeRemaining' | translate }}: {{ timeRemaining() }}
                                </span>
                            </div>
                            <p class="timer-message">
                                {{ isFreeReservation() ? 
                                    ('reservations.payment.confirmWithinTime' | translate) : 
                                    ('reservations.payment.payWithinTime' | translate) 
                                }}
                            </p>
                        </div>

                        <!-- Expired Message -->
                        <div
                            class="payment-expired"
                            *ngIf="isExpired()"
                        >
                            <tui-icon icon="@tui.alert-circle"></tui-icon>
                            <p>
                                {{ 'reservations.payment.expired' | translate }}
                            </p>
                        </div>

                        <div class="payment-actions">
                            <!-- Free reservation button -->
                            <button
                                *ngIf="isFreeReservation() && !isExpired()"
                                tuiButton
                                appearance="primary"
                                size="m"
                                (click)="onConfirmReservation()"
                                class="confirm-button"
                            >
                                <tui-icon icon="@tui.check"></tui-icon>
                                {{ 'reservations.payment.confirmReservation' | translate }}
                            </button>

                            <!-- Paid reservation button -->
                            <button
                                *ngIf="!isFreeReservation() && !isExpired() && reservation()!.status === 'PENDING_PAYMENT'"
                                tuiButton
                                appearance="primary"
                                size="m"
                                (click)="onPayWithStripe()"
                                class="pay-button"
                            >
                                <tui-icon icon="@tui.credit-card"></tui-icon>
                                {{ 'reservations.payment.payWithStripe' | translate }}
                            </button>

                            <!-- Retry payment button for PAYMENT_FAILED -->
                            <button
                                *ngIf="shouldShowRetryButton()"
                                tuiButton
                                appearance="primary"
                                size="m"
                                (click)="onRetryPayment()"
                                class="retry-button"
                            >
                                <tui-icon icon="@tui.refresh"></tui-icon>
                                {{ 'reservations.payment.retryPayment' | translate }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pricing Block for other statuses -->
                <div
                    class="detail-card"
                    *ngIf="!shouldShowPaymentView()"
                >

                    <h3>
                        <tui-icon icon="@tui.credit-card"></tui-icon>
                        {{ 'reservations.detail.pricing' | translate }}
                    </h3>
                    <div class="detail-content">
                        <div class="price-row">
                            <span class="label">
                                {{ 'reservations.payment.basePrice' | translate }}
                            </span>
                            <span class="value">{{ space()!.pricing.tenantPrice }}€</span>
                        </div>
                        <div class="price-row">
                            <span class="label">
                                {{ 'reservations.payment.numberOfDays' | translate }}
                            </span>
                            <span class="value">{{ calculateDays() }}</span>
                        </div>
                        <div class="price-row subtotal">
                            <span class="label">
                                {{ 'reservations.payment.subtotal' | translate }}
                            </span>
                            <span class="value">{{ calculateSubtotal() }}€</span>
                        </div>
                        <div
                            class="price-row"
                            *ngIf="reservation()?.cleaningFee && reservation()!.cleaningFee > 0"
                        >
                            <span class="label">
                                {{ 'reservations.payment.cleaningFee' | translate }}
                            </span>
                            <span class="value">{{ reservation()!.cleaningFee }}€</span>
                        </div>
                        <div
                            class="price-row"
                            *ngIf="calculatePlatformFeeTotal() > 0"
                        >
                            <span class="label">
                                {{ 'reservations.payment.platformFee' | translate }}
                            </span>
                            <span class="value">{{ calculatePlatformFeeTotal() }}€</span>
                        </div>
                        <div
                            class="price-row"
                            *ngIf="reservation()?.deposit && reservation()!.deposit > 0"
                        >
                            <span class="label">
                                {{ 'reservations.payment.deposit' | translate }}
                            </span>
                            <span class="value">{{ reservation()!.deposit }}€</span>
                        </div>
                        <div class="price-row total">
                            <span class="label">
                                {{ 'reservations.payment.total' | translate }}
                            </span>
                            <span class="value">{{ calculateTotalPrice() }}€</span>
                        </div>
                    </div>
                </div>

                <!-- Reservation Info -->
                <div class="detail-card">
                    <h3>
                        <tui-icon icon="@tui.info"></tui-icon>
                        {{ 'reservations.detail.info' | translate }}
                    </h3>
                    <div class="detail-content">
                        <div class="info-row">
                            <span class="label">
                                {{ 'reservations.detail.reservationId' | translate }}
                            </span>
                            <span class="value mono">{{ reservation()!.id }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">
                                {{ 'reservations.detail.createdAt' | translate }}
                            </span>
                            <span class="value">
                                {{ formatDate(reservation()!.createdAt) }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
