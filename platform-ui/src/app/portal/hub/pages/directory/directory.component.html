<div class="directory-container">
  <div class="directory-header">
    <h1>{{ 'directory.title' | translate }}</h1>
  </div>

  <!-- Filters -->
  <div class="filters-container">
    <div class="filter-group">
      <label tuiLabel>
        {{ 'directory.filters.type' | translate }}
        <tui-select
          [ngModel]="getSelectedTypeOption()"
          (ngModelChange)="onTypeChange($event)"
          [stringify]="stringifyType"
          name="typeFilter"
        >
          {{ 'directory.filters.type' | translate }}
          <input
            tuiTextfieldLegacy
            [placeholder]="'directory.filters.type' | translate"
          />
          <tui-data-list-wrapper
            *tuiDataList
            [items]="typeOptions"
            [itemContent]="typeContentTemplate"
          ></tui-data-list-wrapper>
        </tui-select>
      </label>
      <ng-template #typeContentTemplate let-item>
        {{ item.label | translate }}
      </ng-template>
    </div>

    <div class="filter-group">
      <label tuiLabel>
        {{ 'directory.filters.name' | translate }}
        <tui-textfield>
          <input
            tuiTextfield
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            [placeholder]="'directory.filters.namePlaceholder' | translate"
            name="searchFilter"
          />
        </tui-textfield>
      </label>
    </div>

    <div class="filter-group">
      <label tuiLabel>
        {{ 'directory.filters.user' | translate }}
        <tui-textfield tuiChevron [stringify]="stringifyUser">
          <input
            tuiComboBox
            [ngModel]="selectedUser()"
            (ngModelChange)="onUserChange($event)"
            name="userFilter"
            [placeholder]="'directory.filters.user.all' | translate"
          />
          <tui-data-list-wrapper
            *tuiTextfieldDropdown
            new
            [items]="availableUsers() | tuiFilterByInput: userMatcher"
            [itemContent]="userContentTemplate"
          />
        </tui-textfield>
      </label>
      <ng-template #userContentTemplate let-item>
        {{ item.firstName }} {{ item.lastName }} ({{ item.email }})
      </ng-template>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="loading-container">
    <tui-loader size="l"></tui-loader>
  </div>

  <!-- Units List -->
  <div *ngIf="!loading()" class="units-list">
    <div *ngFor="let unit of units()" class="unit-card">
      <div class="unit-content">
        <div class="unit-header">
          <h2>{{ unit.name }}</h2>
          <tui-chip
            appearance="secondary"
            size="s"
          >
            {{ getTypeLabel(unit.type) }}
          </tui-chip>
        </div>

        <div class="unit-members">
          <div *ngIf="unit.members && unit.members.length > 0" class="members-list">
            <section
              *ngFor="let member of unit.members"
              tuiCardLarge="compact"
              [tuiCardCollapsed]="getCollapsedSignal(member.user?.id || '')()"
              class="member-card"
            >
              <header tuiHeader="body-m">
                <hgroup tuiTitle>
                  <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <tui-avatar
                      *ngIf="member.user?.avatarUrl"
                      [src]="member.user.avatarUrl"
                      size="m"
                    ></tui-avatar>
                    <tui-avatar
                      *ngIf="!member.user?.avatarUrl"
                      [src]="(member.user?.firstName || '') + ' ' + (member.user?.lastName || '') | tuiInitials"
                      [style.background]="(member.user?.firstName || '') + ' ' + (member.user?.lastName || '') | tuiAutoColor"
                      size="m"
                    ></tui-avatar>
                    <div>
                      <h2 style="margin: 0;">
                        {{ member.user?.firstName }} {{ member.user?.lastName }}
                      </h2>
                      <p tuiSubtitle *ngIf="member.residenceRole" style="margin: 0;">
                        {{ getResidenceRoleLabel(member.residenceRole) }}
                      </p>
                    </div>
                  </div>
                </hgroup>
                <aside tuiAccessories>
                  <tui-chip
                    *ngIf="isPrimaryUnit(unit, member)"
                    appearance="custom"
                    [style.background-color]="'var(--tui-background-accent-2)'"
                    [style.color]="'var(--tos-text-primary-on-accent-1)'"
                    size="s"
                  >
                    <tui-icon
                      icon="@tui.user-star"
                      [style.color]="'var(--tos-text-primary-on-accent-1)'"
                      size="xs"
                    ></tui-icon>
                    {{ 'units.isPrimaryUnit' | translate }}
                  </tui-chip>
                </aside>
              </header>
              <div tuiCardRow>
                <div tuiTitle *ngIf="member.residenceRole">
                  <div tuiSubtitle>{{ 'directory.role' | translate }}</div>
                  <div>
                    <tui-chip
                      appearance="custom"
                      [style.background-color]="getResidenceRoleLabel(member.residenceRole) | tuiAutoColor"
                      size="s"
                    >
                      {{ getResidenceRoleLabel(member.residenceRole) }}
                    </tui-chip>
                  </div>
                </div>
                <button
                  *ngIf="canShowContactInfo(member)"
                  appearance="secondary"
                  size="s"
                  tuiIconButton
                  type="button"
                  [tuiChevron]="!getCollapsedSignal(member.user?.id || '')()"
                  (click)="toggleCollapsed(member.user?.id || '')"
                >
                  {{ (getCollapsedSignal(member.user?.id || '')() ? 'directory.showContact' : 'directory.hideContact') | translate }}
                </button>
              </div>
              <tui-expand *ngIf="canShowContactInfo(member)" [expanded]="!getCollapsedSignal(member.user?.id || '')()">
                <div class="contact-info">
                  <div tuiTitle *ngIf="member.user?.email">
                    <div tuiSubtitle>{{ 'directory.email' | translate }}</div>
                    <a
                      [href]="'mailto:' + member.user.email"
                      tuiLink
                    >
                      <tui-icon icon="@tui.mail" size="s"></tui-icon>
                      {{ member.user.email }}
                    </a>
                  </div>
                  <div tuiTitle *ngIf="member.user?.phone">
                    <div tuiSubtitle>{{ 'directory.phone' | translate }}</div>
                    <a
                      [href]="'tel:' + member.user.phone"
                      tuiLink
                    >
                      <tui-icon icon="@tui.phone" size="s"></tui-icon>
                      {{ member.user.phone }}
                    </a>
                  </div>
                </div>
              </tui-expand>
            </section>
          </div>
          <div *ngIf="!unit.members || unit.members.length === 0" class="no-members">
            {{ 'directory.noMembers' | translate }}
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="units().length === 0" class="empty-state">
      <p>{{ 'directory.noUnits' | translate }}</p>
    </div>
  </div>

  <!-- Pagination -->
  <div *ngIf="!loading() && totalPages() > 1" class="pagination-container">
    <tui-pagination
      [length]="totalPages()"
      [index]="currentPage()"
      (indexChange)="onPageChange($event)"
    ></tui-pagination>
  </div>
</div>

