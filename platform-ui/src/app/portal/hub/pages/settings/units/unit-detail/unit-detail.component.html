<div class="unit-detail-container">
  <!-- Header -->
  <div class="detail-header">
    <button
      tuiButton
      appearance="flat"
      size="m"
      (click)="onBack()"
      class="back-button"
    >
      <tui-icon icon="@tui.chevron-left"></tui-icon>
      {{ 'settings.units.back' | translate }}
    </button>

    <h1>
      {{ unit()?.name || 'Logement' }}
    </h1>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <tui-loader size="l"></tui-loader>
      <p>{{ 'settings.units.loading' | translate }}</p>
    </div>
  }

  <!-- Error State -->
  @if (error && !loading()) {
    <tui-notification
      appearance="negative"
      size="l"
    >
      {{ error }}
    </tui-notification>
  }

  <!-- Content -->
  @if (!loading() && unit()) {
    <div class="detail-content">
      <!-- Unit Info -->
      <div class="unit-info-section">
        <div class="section-header">
          <h2>{{ 'settings.units.information' | translate }}</h2>
          <div class="section-actions">
            <button
              tuiButton
              appearance="outline"
              size="m"
              [routerLink]="['/hub/settings/units', unit()?.id, 'reservations']"
            >
              <tui-icon icon="@tui.calendar"></tui-icon>
              {{ 'units.reservations.view' | translate }}
            </button>
            <a
              tuiButton
              appearance="outline"
              size="m"
              [href]="'/api/hub/units/' + unit()?.id + '/calendar.ics'"
              download
            >
              <tui-icon icon="@tui.download"></tui-icon>
              {{ 'units.calendar.download' | translate }}
            </a>
          </div>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <strong>{{ 'settings.units.name' | translate }}:</strong>
            <span>{{ unit()?.name }}</span>
          </div>
          <div class="info-item">
            <strong>{{ 'settings.units.createdAt' | translate }}:</strong>
            <span>{{ unit()?.createdAt | date:'short' }}</span>
          </div>
          <div class="info-item">
            <strong>{{ 'settings.units.membersCount' | translate }}:</strong>
            <span>{{ unit()?.members?.length || 0 }}</span>
          </div>
        </div>
      </div>

      <!-- Members Section -->
      <div class="members-section">
        <div class="members-header">
          <h2>{{ 'settings.units.members' | translate }}</h2>
          
          <!-- Add Member Form (only for admins) -->
          @if (isAdmin()) {
            <div class="add-member-form">
              <tui-textfield>
                <label tuiLabel>{{ 'units.addMember' | translate }}</label>
                <input
                  tuiTextfield
                  type="email"
                  [ngModel]="inviteEmail()"
                  (ngModelChange)="inviteEmail.set($event)"
                  [placeholder]="'units.inviteEmailPlaceholder' | translate"
                />
              </tui-textfield>

              <button
                tuiButton
                appearance="primary"
                size="m"
                (click)="addMember()"
                [disabled]="!inviteEmail().trim() || addingMember()"
              >
                <tui-icon icon="@tui.plus"></tui-icon>
                {{ 'units.invite' | translate }}
              </button>
            </div>
          }
        </div>
        
        @if (unit()?.members && unit()!.members!.length > 0) {
          <div class="members-list">
            @for (member of unit()!.members; track member.userId) {
              <div class="member-card">
                <div class="member-main">
                  <div class="member-avatar">
                    @if (member.user?.avatarUrl) {
                      <tui-avatar [src]="member.user.avatarUrl" size="m"></tui-avatar>
                    } @else {
                      <tui-avatar 
                        [src]="(member.user?.firstName || '') + ' ' + (member.user?.lastName || '') | tuiInitials"
                        [style.background]="(member.user?.firstName || '') + ' ' + (member.user?.lastName || '') | tuiAutoColor"
                        size="m">
                      </tui-avatar>
                    }
                  </div>
                  <div class="member-details">
                    <div class="member-header">
                      <div class="member-name">
                        <strong>{{ member.user?.firstName || '' }} {{ member.user?.lastName || '' }}</strong>
                        <span class="member-email">{{ member.user?.email || '' }}</span>
                      </div>
                      <div class="member-role">
                        <span class="role-badge" [class.admin]="member.role === 'ADMIN'">
                          {{ getRoleLabel(member.role || '') }}
                        </span>
                      </div>
                    </div>
                    <div class="member-meta">
                      <tui-icon icon="@tui.calendar" size="s"></tui-icon>
                      <span>{{ 'settings.units.joinedAt' | translate }}: {{ member.joinedAt | date:'short' }}</span>
                    </div>
                    @if (isAdmin() && !isCurrentUser(member)) {
                      <div class="member-actions">
                        @if (member.role === 'ADMIN') {
                          <button
                            tuiButton
                            appearance="outline"
                            size="s"
                            (click)="demoteFromAdmin(member)"
                          >
                            <tui-icon icon="@tui.user-minus"></tui-icon>
                            {{ 'units.demote' | translate }}
                          </button>
                        } @else {
                          <button
                            tuiButton
                            appearance="outline"
                            size="s"
                            (click)="promoteToAdmin(member)"
                          >
                            <tui-icon icon="@tui.user-plus"></tui-icon>
                            {{ 'units.promote' | translate }}
                          </button>
                        }
                        <button
                          tuiButton
                          appearance="outline"
                          size="s"
                          (click)="removeMember(member)"
                        >
                          <tui-icon icon="@tui.trash-2"></tui-icon>
                          {{ 'units.remove' | translate }}
                        </button>
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-members">
            <p>{{ 'settings.units.noMembers' | translate }}</p>
          </div>
        }
      </div>
    </div>
  }
</div>

