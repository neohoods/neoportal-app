<div class="unit-detail-container">
  <!-- Header -->
  <div class="detail-header">
    <div class="header-left">
      <button
        tuiButton
        appearance="flat"
        size="m"
        (click)="onBack()"
        class="back-button"
      >
        <tui-icon icon="@tui.chevron-left"></tui-icon>
        {{ 'common.back' | translate }}
      </button>

      <div class="header-info">
        <h1>{{ unit()!.name || 'Logement' }}</h1>
      </div>
    </div>
    <div class="header-actions">
      <button
        tuiButton
        appearance="primary"
        size="m"
        [routerLink]="['/admin/units', unit()!.id, 'edit']"
      >
        <tui-icon icon="@tui.pen"></tui-icon>
        {{ 'common.edit' | translate }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <tui-loader size="l"></tui-loader>
      <p>{{ 'units.loading' | translate }}</p>
    </div>
  }

  <!-- Error State -->
  @if (error && !loading()) {
    <tui-notification
      appearance="negative"
      size="l"
    >
      {{ error }}
    </tui-notification>
  }

  <!-- Content -->
  @if (!loading() && unit()) {
    <div class="detail-content">
      <!-- Unit Info -->
      <div class="unit-info-section">
        <h2>{{ 'units.information' | translate }}</h2>
        <div class="info-grid">
          <div class="info-item">
            <strong>{{ 'units.types.label' | translate }}:</strong>
            <tui-chip
              appearance="secondary"
              size="s"
            >
              {{ getTypeLabel(unit()!.type) }}
            </tui-chip>
          </div>
          <div class="info-item">
            <strong>{{ 'units.createdAt' | translate }}:</strong>
            <span>{{ unit()!.createdAt | date:'short' }}</span>
          </div>
          <div class="info-item">
            <strong>{{ 'units.membersCount' | translate }}:</strong>
            <span>{{ unit()!.members.length || 0 }}</span>
          </div>
        </div>
      </div>

      <!-- Members Section -->
      <div class="members-section">
        <div class="members-header">
          <h2>{{ 'units.members' | translate }}</h2>
        </div>
        
        @if (unit()!.members && unit()!.members!.length > 0) {
          <div class="members-list">
            @for (member of unit()!.members; track member.userId) {
              <div class="member-card">
                <div class="member-main">
                  <div class="member-avatar">
                    @if (member.user.avatarUrl) {
                      <tui-avatar [src]="member.user.avatarUrl" size="m"></tui-avatar>
                    } @else {
                      <tui-avatar 
                        [src]="(member.user.firstName || '') + ' ' + (member.user.lastName || '') | tuiInitials"
                        [style.background]="(member.user.firstName || '') + ' ' + (member.user.lastName || '') | tuiAutoColor"
                        size="m">
                      </tui-avatar>
                    }
                  </div>
                  <div class="member-details">
                    <div class="member-header">
                      <div class="member-name-section">
                        <div class="member-name-row">
                          <strong>{{ member.user.firstName || '' }} {{ member.user.lastName || '' }}</strong>
                        </div>
                        <span class="member-email">{{ member.user.email || '' }}</span>

                        <div class="member-residence-role-section">
                          @if (!isEditingResidenceRole(member) && member.residenceRole) {
                            <div class="residence-role-display">
                              <tui-chip
                              appearance="secondary"
                                size="m"
                              >
                                {{ getResidenceRoleLabel(member.residenceRole) }}
                              </tui-chip>
                              <button
                                tuiButton
                                appearance="ghost"
                                size="xs"
                                (click)="startEditingResidenceRole(member)"
                                class="edit-residence-role-btn"
                              >
                                <tui-icon icon="@tui.edit-2" size="xs"></tui-icon>
                              </button>
                            </div>
                          } @else if (isEditingResidenceRole(member)) {
                            <div class="residence-role-edit">
                              <tui-textfield tuiChevron [stringify]="stringifyResidenceRole">
                                <input
                                  tuiSelect
                                  [ngModel]="getResidenceRoleForMember(member)"
                                  (ngModelChange)="updateMemberResidenceRole(member, $event)"
                                  name="residenceRole_{{ member.userId }}"
                                  [placeholder]="'units.updateResidenceRole' | translate"
                                />
                                <tui-data-list-wrapper
                                  *tuiTextfieldDropdown
                                  new
                                  [items]="residenceRoleOptions"
                                  [itemContent]="residenceRoleContentTemplate"
                                ></tui-data-list-wrapper>
                              </tui-textfield>
                              <button
                                tuiButton
                                appearance="ghost"
                                size="xs"
                                (click)="cancelEditingResidenceRole()"
                                class="cancel-edit-btn"
                              >
                                <tui-icon icon="@tui.x" size="xs"></tui-icon>
                              </button>
                            </div>
                          }
                        </div>
                      </div>
                      <div class="member-header-right">
                        @if (member.role === 'ADMIN') {
                          <tui-chip
                            appearance="primary"
  
                            size="s"
                          >
                            {{ getRoleLabel(member.role || '') }}
                          </tui-chip>
                        }
                        @if (isPrimaryUnit(member)) {
                          <tui-chip
                            appearance="custom"
                            [style.background-color]="'var(--tui-background-accent-2)'"
                            [style.color]="'var(--tos-text-primary-on-accent-1)'"
                            size="s"
                          >
                            <tui-icon
                              icon="@tui.user-star"
                              [style.color]="'var(--tos-text-primary-on-accent-1)'"
                              size="xs"
                            ></tui-icon>
                            {{ 'units.isPrimaryUnit' | translate }}
                          </tui-chip>
                        }
                      </div>
                    </div>
                    <div class="member-meta">
                      <tui-icon icon="@tui.calendar" size="s"></tui-icon>
                      <span>{{ 'units.joinedAt' | translate }}: {{ member.joinedAt | date:'short' }}</span>
                    </div>
                    <ng-template #residenceRoleContentTemplate let-item>
                      {{ item.label | translate }}
                    </ng-template>
                    @if (!isCurrentUser(member)) {
                      <div class="member-actions">
                        @if (!isPrimaryUnit(member)) {
                          <button
                            tuiButton
                            appearance="outline"
                            size="s"
                            (click)="setAsPrimaryUnit(member)"
                          >
                            <tui-icon icon="@tui.star"></tui-icon>
                            {{ 'units.setAsPrimaryUnit' | translate }}
                          </button>
                        }
                        @if (member.role === 'ADMIN') {
                          <button
                            tuiButton
                            appearance="outline"
                            size="s"
                            (click)="demoteFromAdmin(member)"
                          >
                            <tui-icon icon="@tui.user-minus"></tui-icon>
                            {{ 'units.demote' | translate }}
                          </button>
                        } @else {
                          <button
                            tuiButton
                            appearance="outline"
                            size="s"
                            (click)="promoteToAdmin(member)"
                          >
                            <tui-icon icon="@tui.user-plus"></tui-icon>
                            {{ 'units.promote' | translate }}
                          </button>
                        }
                        <button
                          tuiButton
                          appearance="outline"
                          size="s"
                          (click)="removeMember(member)"
                        >
                          <tui-icon icon="@tui.trash-2"></tui-icon>
                          {{ 'units.remove' | translate }}
                        </button>
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-members">
            <p>{{ 'units.noMembers' | translate }}</p>
          </div>
        }

        <!-- Add Member Form -->
        <div class="add-member-form">
          <label tuiLabel>
            {{ 'units.addMember' | translate }}
            <tui-textfield tuiChevron [stringify]="stringifyUser">
              <input
                tuiComboBox
                [ngModel]="selectedUser()"
                (ngModelChange)="selectedUser.set($event)"
                name="userSelect"
                [placeholder]="'units.selectUser' | translate"
              />
              <tui-data-list-wrapper
                *tuiTextfieldDropdown
                new
                [items]="getAvailableUsersForSelect() | tuiFilterByInput: userMatcher"
                [itemContent]="userContent"
              ></tui-data-list-wrapper>
            </tui-textfield>
          </label>

          <ng-template #userContent let-user>
            {{ user.firstName }} {{ user.lastName }} ({{ user.email }})
          </ng-template>

          <button
            tuiButton
            appearance="primary"
            size="m"
            (click)="addMember()"
            [disabled]="!selectedUser() || addingMember()"
          >
            <tui-icon icon="@tui.plus"></tui-icon>
            {{ 'units.add' | translate }}
          </button>
        </div>
      </div>
    </div>
  }
</div>

