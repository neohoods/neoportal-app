<div class="unit-detail-container">
  <!-- Header -->
  <div class="detail-header">
    <div class="header-left">
      <button
        tuiButton
        appearance="flat"
        size="m"
        (click)="onBack()"
        class="back-button"
      >
        <tui-icon icon="@tui.chevron-left"></tui-icon>
        {{ 'common.back' | translate }}
      </button>

      <div class="header-info">
        <h1>{{ unit()?.name || 'Logement' }}</h1>
      </div>
    </div>
    <div class="header-actions">
      <button
        tuiButton
        appearance="primary"
        size="m"
        [routerLink]="['/admin/units', unit()?.id, 'edit']"
      >
        <tui-icon icon="@tui.pen"></tui-icon>
        {{ 'common.edit' | translate }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <tui-loader size="l"></tui-loader>
      <p>{{ 'units.loading' | translate }}</p>
    </div>
  }

  <!-- Error State -->
  @if (error && !loading()) {
    <tui-notification
      appearance="negative"
      size="l"
    >
      {{ error }}
    </tui-notification>
  }

  <!-- Content -->
  @if (!loading() && unit()) {
    <div class="detail-content">
      <!-- Unit Info -->
      <div class="unit-info-section">
        <h2>{{ 'units.information' | translate }}</h2>
        <div class="info-grid">
          <div class="info-item">
            <strong>{{ 'units.name' | translate }}:</strong>
            <span>{{ unit()?.name }}</span>
          </div>
          <div class="info-item">
            <strong>{{ 'units.createdAt' | translate }}:</strong>
            <span>{{ unit()?.createdAt | date:'short' }}</span>
          </div>
          <div class="info-item">
            <strong>{{ 'units.membersCount' | translate }}:</strong>
            <span>{{ unit()?.members?.length || 0 }}</span>
          </div>
        </div>
      </div>

      <!-- Members Section -->
      <div class="members-section">
        <div class="members-header">
          <h2>{{ 'units.members' | translate }}</h2>
          
          <!-- Add Member Form -->
          <div class="add-member-form">
            <label tuiLabel>
              {{ 'units.addMember' | translate }}
              <tui-textfield tuiChevron [stringify]="stringifyUser">
                <input
                  tuiSelect
                  [ngModel]="selectedUser()"
                  (ngModelChange)="selectedUser.set($event)"
                  name="userSelect"
                  [placeholder]="'units.selectUser' | translate"
                />
                <tui-data-list-wrapper
                  *tuiTextfieldDropdown
                  new
                  [items]="getAvailableUsersForSelect()"
                  [itemContent]="userContent"
                ></tui-data-list-wrapper>
              </tui-textfield>
            </label>

            <ng-template #userContent let-user>
              {{ user.firstName }} {{ user.lastName }} ({{ user.email }})
            </ng-template>

            <button
              tuiButton
              appearance="primary"
              size="m"
              (click)="addMember()"
              [disabled]="!selectedUser() || addingMember()"
            >
              <tui-icon icon="@tui.plus"></tui-icon>
              {{ 'units.add' | translate }}
            </button>
          </div>
        </div>
        
        @if (unit()?.members && unit()!.members!.length > 0) {
          <div class="members-list">
            @for (member of unit()!.members; track member.userId) {
              <div class="member-card">
                <div class="member-main">
                  <div class="member-avatar">
                    @if (member.user?.avatarUrl) {
                      <tui-avatar [src]="member.user.avatarUrl" size="m"></tui-avatar>
                    } @else {
                      <tui-avatar 
                        [src]="(member.user?.firstName || '') + ' ' + (member.user?.lastName || '') | tuiInitials"
                        [style.background]="(member.user?.firstName || '') + ' ' + (member.user?.lastName || '') | tuiAutoColor"
                        size="m">
                      </tui-avatar>
                    }
                  </div>
                  <div class="member-details">
                    <div class="member-header">
                      <div class="member-name">
                        <strong>{{ member.user?.firstName || '' }} {{ member.user?.lastName || '' }}</strong>
                        <span class="member-email">{{ member.user?.email || '' }}</span>
                      </div>
                      <div class="member-role">
                        <span class="role-badge" [class.admin]="member.role === 'ADMIN'">
                          {{ getRoleLabel(member.role || '') }}
                        </span>
                      </div>
                    </div>
                    <div class="member-meta">
                      <tui-icon icon="@tui.calendar" size="s"></tui-icon>
                      <span>{{ 'units.joinedAt' | translate }}: {{ member.joinedAt | date:'short' }}</span>
                    </div>
                    @if (!isCurrentUser(member)) {
                      <div class="member-actions">
                        @if (member.role === 'ADMIN') {
                          <button
                            tuiButton
                            appearance="outline"
                            size="s"
                            (click)="demoteFromAdmin(member)"
                          >
                            <tui-icon icon="@tui.user-minus"></tui-icon>
                            {{ 'units.demote' | translate }}
                          </button>
                        } @else {
                          <button
                            tuiButton
                            appearance="outline"
                            size="s"
                            (click)="promoteToAdmin(member)"
                          >
                            <tui-icon icon="@tui.user-plus"></tui-icon>
                            {{ 'units.promote' | translate }}
                          </button>
                        }
                        <button
                          tuiButton
                          appearance="outline"
                          size="s"
                          (click)="removeMember(member)"
                        >
                          <tui-icon icon="@tui.trash-2"></tui-icon>
                          {{ 'units.remove' | translate }}
                        </button>
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-members">
            <p>{{ 'units.noMembers' | translate }}</p>
          </div>
        }
      </div>
    </div>
  }
</div>

