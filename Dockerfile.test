FROM qcastel/maven-release:0.0.44

COPY ./mvn-action.sh /usr/local/bin

# Installer PostgreSQL, postgresql-client et postgresql-contrib (pour uuid-ossp)
RUN apk add --no-cache postgresql postgresql-client postgresql-contrib

# Créer le répertoire de données PostgreSQL (initialisation au runtime, pas au build time)
RUN mkdir -p /var/lib/postgresql/data && \
    chown -R postgres:postgres /var/lib/postgresql/data

# Copier le code source
WORKDIR /github/workspace
COPY . /github/workspace

# Installer su-exec pour changer d'utilisateur
RUN apk add --no-cache su-exec

# Variable d'environnement pour indiquer qu'on utilise PostgreSQL local
ENV USE_LOCAL_POSTGRES=true

# Don't set JAVA_HOME here - let mvn-action.sh handle it
# This prevents issues with JAVA_HOME being set to an invalid value
# The script will find and set JAVA_HOME correctly before any Java commands

# Entrypoint pour exécuter le script
ENTRYPOINT ["/usr/local/bin/mvn-action.sh"]
CMD ["clean", "compile", "-DskipTests"]
