name: release version

on:
  push:
    branches:
      - main

jobs:
  prepare:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && startsWith(github.event.head_commit.message, '[release]')"
    outputs:
      app-version: ${{ steps.vars.outputs.app-version }}
    steps:
      - uses: actions/checkout@v1

      - name: Prepare release
        id: vars
        run: |
          cp openapi.yaml platform-ui/
          cp openapi.yaml platform-api/
          VERSION=$(grep -oP '<version>\K[^<]+' platform-api/pom.xml | head -1 | sed 's/-SNAPSHOT$//')
          echo "app-version=$VERSION"
          echo "app-version=$VERSION" >> $GITHUB_OUTPUT

  build-backend:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v1

      - name: Copy openapi.yaml
        run: cp openapi.yaml platform-api/

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: /root/.m2
          key: ${{ runner.os }}-m2-${{ needs.prepare.outputs.app-version }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build and Test
        uses: qcastel/github-actions-maven-cmd@master
        env:
          # Use local PostgreSQL (started by the action) instead of Testcontainers
          USE_LOCAL_POSTGRES: true
        with:
          maven-args: "clean verify -Ddockerfile.skip -DdockerCompose.skip -Djib.skip"

      - name: Release
        uses: qcastel/github-actions-maven-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_GITHUB_TOKEN }}
          JAVA_HOME: /usr/lib/jvm/java-21-openjdk/
        with:
          release-branch-name: "main"
          maven-project-folder: "platform-api/"

          git-release-bot-name: "bot-theopenshelf"
          git-release-bot-email: "bot@theopenshelf.dev"

          docker-registry-id: ghcr.io/neohoods
          docker-registry-username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          docker-registry-password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

          maven-args: "-Dmaven.javadoc.skip=true -DskipTests -DskipITs -Dmaven.deploy.skip=true"

          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

          gpg-enabled: true
          gpg-key-id: ${{ secrets.GPG_KEY_ID }}
          gpg-key: ${{ secrets.GPG_KEY }}

  build-frontend-amd64:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v1

      - name: Copy openapi.yaml
        run: cp openapi.yaml platform-ui/

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: platform-ui/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('platform-ui/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io/neohoods
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and push AMD64
        uses: docker/build-push-action@v2
        with:
          context: ./platform-ui
          push: true
          platforms: linux/amd64
          cache-from: type=gha,scope=frontend-amd64
          cache-to: type=gha,mode=min,scope=frontend-amd64
          tags: ghcr.io/neohoods/portal-platform-ui:${{ needs.prepare.outputs.app-version }}

  deploy:
    runs-on: ubuntu-latest
    needs: [prepare, build-backend, build-frontend-amd64]
    steps:
      - uses: actions/checkout@v1

      - name: Deploy
        uses: qcastel/github-actions-update-helm@master
        with:
          branch-name: main

          git-release-bot-name: "bot-theopenshelf"
          git-release-bot-email: "bot@theopenshelf.dev"

          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

          repository: git@github.com:neohoods/neoportal-helm.git
          file-path: charts/neohoods-portal/values.yaml

          yaml-paths: "backend.image.tag,frontend.image.tag"

          tag: ${{ needs.prepare.outputs.app-version }}

          gpg-enabled: true
          gpg-key-id: ${{ secrets.GPG_KEY_ID }}
          gpg-key: ${{ secrets.GPG_KEY }}
